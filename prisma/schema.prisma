// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// Updated for User Profile features

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model User {
   id        String   @id @default(cuid())
   address   String?  @unique // Keep for backward compatibility
   email     String   @unique
   username  String?
   description String?
   avatarUrl String?
   achievements String[] @default([])
   twitter   String?
   discord   String?
   telegram  String?
   website   String?
   isAdmin   Boolean  @default(false)
   isBanned  Boolean  @default(false)
   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt
   emailVerified DateTime?
   image String?
   name String?

   bets         Bet[]
   transactions Transaction[]
   createdEvents Event[]
   messages     Message[]
   reactions    MessageReaction[]
   notifications Notification[]
   sessions Session[]
   accounts Account[]

   @@index([address])
 }

model Event {
   id             String   @id @default(cuid())
   title          String
   description    String
   categories     String[]  @default([]) // Array of categories: CRYPTO, SPORTS, POLITICS, etc.
   imageUrl       String?
   resolutionDate DateTime
   status         String   @default("ACTIVE") // ACTIVE, RESOLVED, CANCELLED
   result         String?  // YES, NO, or Option ID
   isHidden       Boolean  @default(false)
   rules          String?  @db.Text // Markdown supported rules text

   // Full-text search vector for optimized search performance
   searchVector   Unsupported("tsvector")?

   // AMM Parameters for LMSR
   liquidityParameter Float    @default(100.0) // b parameter in LMSR
   qYes              Float    @default(0.0)    // Cumulative YES tokens
   qNo               Float    @default(0.0)    // Cumulative NO tokens
   initialLiquidity  Float    @default(100.0) // Initial liquidity amount

   // Cached current odds for performance
   yesOdds          Float?
   noOdds           Float?

   creatorId      String?
   creator        User?    @relation(fields: [creatorId], references: [id])

   createdAt      DateTime @default(now())
   updatedAt      DateTime @updatedAt

   bets           Bet[]
   // messages       Message[]

   @@index([status, createdAt])
   @@index([categories])
   @@index([creatorId])
   @@index([title])
   @@index([description])
   @@index([status, resolutionDate])
   @@index([categories, status])
   // Full-text search GIN index for fast search queries
   @@index([searchVector], type: Gin)
}

model Bet {
  id            String   @id @default(cuid())
  amount        Float
  option        String   // YES, NO, or custom option
  priceAtTrade  Float?   // Price of the outcome token at time of trade

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  eventId   String
  event     Event    @relation(fields: [eventId], references: [id])

  createdAt DateTime @default(now())

  @@index([eventId])
  @@index([userId])
  @@index([createdAt])
}

model Transaction {
  id        String   @id @default(cuid())
  hash      String   @unique
  type      String   // DEPOSIT, WITHDRAW, BET_PAYOUT
  amount    Float
  status    String   // PENDING, CONFIRMED, FAILED
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
}

model Message {
  id        String   @id @default(cuid())
  text      String
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  eventId   String
  // event     Event    @relation(fields: [eventId], references: [id])
  
  createdAt DateTime @default(now())
  editedAt  DateTime?
  isDeleted Boolean  @default(false)
  
  // Threading
  parentId  String?
  parent    Message? @relation("Thread", fields: [parentId], references: [id])
  replies   Message[] @relation("Thread")

  // Reactions
  reactions MessageReaction[]

  @@index([eventId, createdAt])
  @@index([userId])
  @@index([parentId])
}

model MessageReaction {
  id        String   @id @default(cuid())
  type      String   // LIKE, DISLIKE
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  messageId String
  message   Message  @relation(fields: [messageId], references: [id])
  
  createdAt DateTime @default(now())

  @@unique([userId, messageId]) // One reaction per user per message
}

model Notification {
  id        String   @id @default(cuid())
  type      String   // REPLY, MENTION, BET_RESULT, FAVORITE_UPDATE
  message   String
  resourceId String? // Link to event or message
  isRead    Boolean  @default(false)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
}

model Session {
 id           String   @id @default(cuid())
 sessionToken String   @unique
 userId       String
 expires      DateTime
 user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
 id                String  @id @default(cuid())
 userId            String
 type              String
 provider          String
 providerAccountId String
 refresh_token     String?
 access_token      String?
 expires_at        Int?
 token_type        String?
 scope             String?
 id_token          String?
 session_state     String?
 user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

 @@unique([provider, providerAccountId])
}

model VerificationToken {
 identifier String
 token      String   @unique
 expires    DateTime

 @@unique([identifier, token])
}
